/*
 * Copyright (c) 2012-2014, Stuart Wheater, Newcastle upon Tyne, England. All rights reserved.
 */

// Device driver for BCM2835 - EMMC (External Mass Media Controller)

#include <Kernel/StdTypes.h>
#include <Kernel/Logging.h>
#include <Device/BCM2835_SystemTimer.h>
#include <Device/BCM2835_EMMC.h>

#define EMMC_BASE                  ((volatile UnsignedWord32*) 0x20300000)
#define EMMC_ARG2_OFFSET           (0x00)
#define EMMC_BLKSIZECNT_OFFSET     (0x01)
#define EMMC_ARG1_OFFSET           (0x02)
#define EMMC_CMDTM_OFFSET          (0x03)
#define EMMC_RESP0_OFFSET          (0x04)
#define EMMC_RESP1_OFFSET          (0x05)
#define EMMC_RESP2_OFFSET          (0x06)
#define EMMC_RESP3_OFFSET          (0x07)
#define EMMC_DATA_OFFSET           (0x08)
#define EMMC_STATUS_OFFSET         (0x09)
#define EMMC_CONTROL0_OFFSET       (0x0A)
#define EMMC_CONTROL1_OFFSET       (0x0B)
#define EMMC_INTERRUPT_OFFSET      (0x0C)
#define EMMC_IRPT_MASK_OFFSET      (0x0D)
#define EMMC_IRPT_EN_OFFSET        (0x0E)
#define EMMC_CONTROL2_OFFSET       (0x0F)
#define EMMC_FORCE_IRPT_OFFSET     (0x14)
#define EMMC_BOOT_TIMEOUT_OFFSET   (0x1C)
#define EMMC_DBG_SEL_OFFSET        (0x1D)
#define EMMC_EXRDFIFO_CFG_OFFSET   (0x20)
#define EMMC_EXRDFIFO_EN_OFFSET    (0x21)
#define EMMC_TUNE_STEP_OFFSET      (0x22)
#define EMMC_TUNE_STEPS_STD_OFFSET (0x23)
#define EMMC_TUNE_STEPS_DDR_OFFSET (0x24)
#define EMMC_SPI_INT_SPT_OFFSET    (0x3C)
#define EMMC_SLOTISR_VER_OFFSET    (0x3F)

#define EMMC_CMDTM_BLOCKCOUNT_DISABLE_BIT  (0x00000000)
#define EMMC_CMDTM_BLOCKCOUNT_ENABLE_BIT   (0x00000002)
#define EMMC_CMDTM_BLOCKCOUNT_MASK         (0x00000002)
#define EMMC_CMDTM_COMPCMD_NONE_BITS       (0x00000000)
#define EMMC_CMDTM_COMPCMD_CMD12_BITS      (0x00000004)
#define EMMC_CMDTM_COMPCMD_CMD23_BITS      (0x00000008)
#define EMMC_CMDTM_COMPCMD_MASK            (0x0000000C)
#define EMMC_CMDTM_DATADIR_HOSTTOCARD_BIT  (0x00000000)
#define EMMC_CMDTM_DATADIR_CARDTOHOST_BIT  (0x00000010)
#define EMMC_CMDTM_DATADIR_MASK            (0x00000010)
#define EMMC_CMDTM_DATABLOCK_SINGLE_BIT    (0x00000000)
#define EMMC_CMDTM_DATABLOCK_MULTIPLE_BIT  (0x00000020)
#define EMMC_CMDTM_DATABLOCK_MASK          (0x00000020)
#define EMMC_CMDTM_RESPTYPE_NO_BITS        (0x00000000)
#define EMMC_CMDTM_RESPTYPE_136BIT_BITS    (0x00010000)
#define EMMC_CMDTM_RESPTYPE_48BIT_BITS     (0x00020000)
#define EMMC_CMDTM_RESPTYPE_48BITBUSY_BITS (0x00030000)
#define EMMC_CMDTM_RESPTYPE_MASK           (0x00030000)
#define EMMC_CMDTM_CHKCRC_DISABLE_BIT      (0x00000000)
#define EMMC_CMDTM_CHKCRC_ENABLE_BIT       (0x00080000)
#define EMMC_CMDTM_CHKCRC_MASK             (0x00080000)
#define EMMC_CMDTM_CHKINDEX_DISABLE_BIT    (0x00000000)
#define EMMC_CMDTM_CHKINDEX_ENABLE_BIT     (0x00100000)
#define EMMC_CMDTM_CHKINDEX_MASK           (0x00100000)
#define EMMC_CMDTM_ISDATA_NODATA_BIT       (0x00000000)
#define EMMC_CMDTM_ISDATA_DATA_BIT         (0x00200000)
#define EMMC_CMDTM_ISDATA_MASK             (0x00200000)
#define EMMC_CMDTM_CMDTYPE_NORMAL_BITS     (0x00000000)
#define EMMC_CMDTM_CMDTYPE_SUSPEND_BITS    (0x00400000)
#define EMMC_CMDTM_CMDTYPE_RESUME_BITS     (0x00800000)
#define EMMC_CMDTM_CMDTYPE_ABORT_BITS      (0x00C00000)
#define EMMC_CMDTM_CMDTYPE_MASK            (0x00C00000)
#define EMMC_CMDTM_CMDINDEX_SHIFT          (24)
#define EMMC_CMDTM_CMDINDEX_MASK           (0x3F000000)

#define EMMC_CONTROL0_MODE_SPI_ENABLE_BIT      (0x00100000)
#define EMMC_CONTROL0_MODE_SPI_DISABLE_BIT     (0x00000000)
#define EMMC_CONTROL0_MODE_BOOT_ENABLE_BIT     (0x00200000)
#define EMMC_CONTROL0_MODE_BOOT_DISABLE_BIT    (0x00000000)
#define EMMC_CONTROL0_MODE_ALTBOOT_ENABLE_BIT  (0x00400000)
#define EMMC_CONTROL0_MODE_ALTBOOT_DISABLE_BIT (0x00000000)
#define EMMC_CONTROL0_MODE_MASK                (0x00700000)

#define EMMC_CONTROL1_CLOCK_STABLE_NO_BIT               (0x00000000)
#define EMMC_CONTROL1_CLOCK_STABLE_YES_BIT              (0x00000002)
#define EMMC_CONTROL1_CLOCK_STABLE_MASK                 (0x00000002)
#define EMMC_CONTROL1_RESET_HOST_CIRCUIT_ENABLE_BIT     (0x01000000)
#define EMMC_CONTROL1_RESET_HOST_CIRCUIT_DISABLE_BIT    (0x00000000)
#define EMMC_CONTROL1_RESET_COMMAND_CIRCUIT_ENABLE_BIT  (0x02000000)
#define EMMC_CONTROL1_RESET_COMMAND_CIRCUIT_DISABLE_BIT (0x00000000)
#define EMMC_CONTROL1_RESET_DATA_CIRCUIT_ENABLE_BIT     (0x04000000)
#define EMMC_CONTROL1_RESET_DATA_CIRCUIT_DISABLE_BIT    (0x00000000)
#define EMMC_CONTROL1_RESET_MASK                        (0x07000000)

static void emmcCommand(UnsignedWord32 command, UnsignedWord32 argument)
{
    *(EMMC_BASE + EMMC_ARG1_OFFSET)  = argument;
    *(EMMC_BASE + EMMC_CMDTM_OFFSET) = command;

    // Check Response
}

UnsignedByte emmcInit(void)
{
    *(EMMC_BASE + EMMC_CONTROL1_OFFSET) = EMMC_CONTROL1_RESET_HOST_CIRCUIT_ENABLE_BIT;

    while (((*(EMMC_BASE + EMMC_CONTROL1_OFFSET)) & EMMC_CONTROL1_RESET_MASK) != 0) ;

    *(EMMC_BASE + EMMC_CONTROL0_OFFSET) = EMMC_CONTROL0_MODE_SPI_DISABLE_BIT | EMMC_CONTROL0_MODE_BOOT_DISABLE_BIT | EMMC_CONTROL0_MODE_ALTBOOT_DISABLE_BIT;
    *(EMMC_BASE + EMMC_CONTROL2_OFFSET) = 0x00000000;

    while (((*(EMMC_BASE + EMMC_CONTROL1_OFFSET)) & EMMC_CONTROL1_CLOCK_STABLE_MASK) == EMMC_CONTROL1_CLOCK_STABLE_YES_BIT) ;

    emmcCommand(EMMC_CMDTM_BLOCKCOUNT_DISABLE_BIT | EMMC_CMDTM_COMPCMD_NONE_BITS | EMMC_CMDTM_DATADIR_HOSTTOCARD_BIT | EMMC_CMDTM_DATABLOCK_SINGLE_BIT | EMMC_CMDTM_RESPTYPE_NO_BITS | EMMC_CMDTM_CHKCRC_ENABLE_BIT | EMMC_CMDTM_CHKINDEX_ENABLE_BIT | EMMC_CMDTM_ISDATA_NODATA_BIT | EMMC_CMDTM_CMDTYPE_NORMAL_BITS | (0 << EMMC_CMDTM_CMDINDEX_SHIFT), 0x00000000);


    // More!!
    // systemtimerWait(100);

    return 0x00;
}

UnsignedByte emmcReadBlock(UnsignedWord32 blockNumber, UnsignedByte block[512])
{
    return 0x00;
}

UnsignedByte emmcShutdown(void)
{
    return 0x00;
}
